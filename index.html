<!doctype html>
<html lang="bg">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>EV Log</title>

  <!-- PWA -->
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#000000">

  <style>
    :root{
      --bg:#000;
      --panel:#060606;
      --line:#141414;
      --text:#f2f2f2;
      --muted:#a3a3a3;
      --good:#86efac;
      --bad:#fca5a5;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      line-height:1.35;
    }
    .wrap{max-width:1100px; margin:0 auto; padding:14px 12px 40px}
    .topbar{display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap; margin-bottom:10px}
    .brand{display:flex; flex-direction:column; gap:2px}
    .brand h1{font-size:16px; margin:0}
    .brand .sub{font-size:12px; color:var(--muted)}
    .tabs{display:flex; gap:6px; flex-wrap:wrap}
    .tabbtn{
      padding:8px 10px;
      border-radius:12px;
      border:1px solid var(--line);
      background:transparent;
      color:var(--muted);
      cursor:pointer;
      font-size:13px;
    }
    .tabbtn.active{
      color:var(--text);
      border-color:#242424;
      background:#090909;
    }

    .card{
      border:1px solid var(--line);
      background:var(--panel);
      border-radius:16px;
      padding:12px;
    }
    .divider{height:1px; background:var(--line); margin:12px 0}
    .section{display:none}
    .section.active{display:block}

    label{display:block; font-size:12px; color:var(--muted); margin:0 0 6px}
    input, select{
      width:100%;
      padding:11px 11px;
      border-radius:12px;
      border:1px solid var(--line);
      background:#030303;
      color:var(--text);
      outline:none;
    }
    input:focus, select:focus{border-color:#252525; box-shadow:0 0 0 3px rgba(255,255,255,.06)}
    .row{display:grid; grid-template-columns:1fr; gap:10px}
    @media (min-width: 760px){ .row{grid-template-columns:1fr 1fr} }
    .row3{display:grid; grid-template-columns:1fr; gap:10px}
    @media (min-width: 980px){ .row3{grid-template-columns:1fr 1fr 1fr} }

    .actions{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; align-items:center}
    button{
      padding:9px 10px;
      border-radius:12px;
      border:1px solid var(--line);
      background:#070707;
      color:var(--text);
      cursor:pointer;
      font-size:13px;
    }
    button:hover{border-color:#242424}
    .mini{padding:7px 9px; font-size:12px; color:var(--muted); background:transparent}

    .small{font-size:12px; color:var(--muted)}
    .msg{margin-top:8px}

    /* KPI */
    .kpi{display:grid; grid-template-columns:1fr; gap:10px}
    @media (min-width: 760px){ .kpi{grid-template-columns:1fr 1fr} }
    .box{
      border:1px solid var(--line);
      background:#030303;
      border-radius:14px;
      padding:12px;
    }
    .t{font-size:12px; color:var(--muted); margin-bottom:6px}
    .v{font-size:18px; font-weight:700}
    .good{color:var(--good)}
    .bad{color:var(--bad)}

    /* Table */
    table{width:100%; border-collapse:collapse; margin-top:10px; font-size:13px}
    th, td{padding:10px 8px; border-bottom:1px solid var(--line); text-align:right; vertical-align:top}
    th:first-child, td:first-child{text-align:left}
    th:nth-child(2), td:nth-child(2){text-align:left}
    .tag{
      display:inline-block;
      padding:2px 8px;
      border:1px solid var(--line);
      border-radius:999px;
      background:#050505;
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
    }
    .note{display:block; margin-top:4px; color:var(--muted); font-size:12px}
    .right{display:flex; justify-content:flex-end}

    details{border:1px solid var(--line); border-radius:14px; background:#030303; padding:10px 10px}
    summary{cursor:pointer; color:var(--muted); font-size:12px; user-select:none; list-style:none}
    summary::-webkit-details-marker{display:none}

    /* Make More menu look like a button */
    .actions details { border:0; padding:0; background:transparent; }
    .actions summary { list-style:none; }
    .actions summary::-webkit-details-marker{display:none}

    /* Toast */
    #toast{
      position: fixed;
      left: 50%;
      bottom: 16px;
      transform: translateX(-50%);
      background: rgba(15,15,15,.92);
      border: 1px solid var(--line);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 14px;
      font-size: 13px;
      box-shadow: 0 10px 30px rgba(0,0,0,.45);
      opacity: 0;
      pointer-events: none;
      transition: opacity .18s ease, transform .18s ease;
      max-width: min(520px, calc(100vw - 24px));
      text-align: center;
      z-index: 9999;
    }
    #toast.show{
      opacity: 1;
      transform: translateX(-50%) translateY(-2px);
    }
    #toast.good{ border-color: rgba(134,239,172,.25); }
    #toast.bad{ border-color: rgba(252,165,165,.25); }
  </style>
</head>
<body>
<div class="wrap">

  <div class="topbar">
    <div class="brand">
      <h1>EV Log</h1>
      <div class="sub">clean • fast • prices saved per entry</div>
    </div>
    <div class="tabs">
      <button class="tabbtn active" data-tab="log">Log</button>
      <button class="tabbtn" data-tab="summary">Summary</button>
      <button class="tabbtn" data-tab="settings">Settings</button>
      <button class="tabbtn" data-tab="compare">Compare</button>
    </div>
  </div>

  <div class="card">

    <!-- LOG -->
    <div id="tab-log" class="section active">

      <div class="row">
        <div>
          <label>Дата</label>
          <input id="e_date" type="date" />
        </div>
        <div>
          <label>kWh</label>
          <input id="e_kwh" type="number" step="0.1" min="0" placeholder="40" />
        </div>
      </div>

      <div class="row3" style="margin-top:10px">
        <div>
          <label>Тип</label>
          <select id="e_type">
            <option value="public">Публично</option>
            <option value="public_exp">Публично скъпо</option>
            <option value="home">Домашно</option>
            <option value="home_exp">Домашно скъпо</option>
            <option value="custom">Друга (ръчно)</option>
          </select>
        </div>
        <div>
          <label>Цена (£/kWh)</label>
          <input id="e_price" type="number" step="0.001" min="0" />
        </div>
        <div>
          <label>Бележка</label>
          <input id="e_note" type="text" placeholder="Octopus Go / BP Pulse..." />
        </div>
      </div>

      <div class="actions">
        <button id="addBtn" type="button">Add</button>
        <button id="sameBtn" type="button">Same as last</button>

        <details style="margin-left:auto">
          <summary class="tabbtn" style="padding:8px 10px">⋯ More</summary>
          <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:10px">
            <button id="exportBtn" class="mini" type="button">Export</button>
            <button id="csvBtn" class="mini" type="button">CSV</button>

            <button id="backupFileBtn" class="mini" type="button">Backup file</button>
            <button id="restoreFileBtn" class="mini" type="button">Restore file</button>
            <input id="restoreFileInput" type="file" accept="application/json,.json" style="display:none" />

            <button id="importBtn" class="mini" type="button">Import</button>
            <button id="clearBtn" class="mini" type="button">Clear</button>
          </div>
        </details>
      </div>

      <details style="margin-top:10px">
        <summary>Details (breakdown)</summary>
        <div class="divider"></div>
        <div class="small" id="breakdown_log"></div>
      </details>

      <div id="monthLine" class="small" style="margin-top:10px"></div>
      <div id="lastMonthLine" class="small" style="margin-top:4px"></div>

      <div class="row" style="margin-top:10px">
        <div>
          <label>Период</label>
          <select id="monthFilter">
            <option value="all">All</option>
            <option value="this">This month</option>
            <option value="last">Last month</option>
          </select>
        </div>
      </div>

      <table>
        <thead>
          <tr>
            <th>Дата</th>
            <th>Тип</th>
            <th>kWh</th>
            <th>£/kWh</th>
            <th>Цена (£)</th>
            <th>Saved (£)</th>
            <th></th> <!-- Copy -->
            <th></th> <!-- Edit/Save -->
            <th></th> <!-- Del/Cancel -->
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
        <tfoot id="tfoot"></tfoot>
      </table>
    </div>

    <!-- SUMMARY -->
    <div id="tab-summary" class="section">
      <div class="kpi">
        <div class="box">
          <div class="t">Общо заредени</div>
          <div class="v" id="tot_kwh">—</div>
          <div class="small">kWh</div>
        </div>
        <div class="box">
          <div class="t">Общо платено (зареждания)</div>
          <div class="v" id="tot_cost">—</div>
          <div class="small">£</div>
        </div>
        <div class="box">
          <div class="t">Публични зареждания</div>
          <div class="v" id="public_cost">—</div>
          <div class="small">£ (public + public expensive)</div>
        </div>
        <div class="box">
          <div class="t">Спестено vs базова публична</div>
          <div class="v" id="saved_vs_public">—</div>
          <div class="small">£ (за НЕ-публични)</div>
        </div>
        <div class="box">
          <div class="t">Инвестиция</div>
          <div class="v" id="inv_total">—</div>
          <div class="small">£ (charger + install)</div>
        </div>
        <div class="box">
          <div class="t">Остава да се изплати</div>
          <div class="v" id="remain_payback">—</div>
          <div class="small" id="remain_note">Инвестиция + публични − спестено</div>
        </div>
      </div>

      <details style="margin-top:10px">
        <summary>Details (breakdown)</summary>
        <div class="divider"></div>
        <div class="small" id="breakdown_summary"></div>
      </details>
    </div>

    <!-- SETTINGS -->
    <div id="tab-settings" class="section">
      <details open>
        <summary>Prices</summary>
        <div class="divider"></div>

        <div class="row">
          <div>
            <label>Публично (£/kWh) — базова за сравнение</label>
            <input id="p_public" type="number" step="0.001" min="0" value="0.56" />
          </div>
          <div>
            <label>Публично скъпо (£/kWh)</label>
            <input id="p_public_exp" type="number" step="0.001" min="0" value="0.76" />
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <div>
            <label>Домашно (£/kWh)</label>
            <input id="p_home" type="number" step="0.001" min="0" value="0.09" />
          </div>
          <div>
            <label>Домашно скъпо (£/kWh)</label>
            <input id="p_home_exp" type="number" step="0.001" min="0" value="0.30" />
          </div>
        </div>

        <div class="small" style="margin-top:10px">
          Saved(£) за ред = (Публично базово − цена на реда) × kWh (само за НЕ-публични).
        </div>
      </details>

      <details style="margin-top:10px">
        <summary>Charger</summary>
        <div class="divider"></div>
        <div class="row">
          <div>
            <label>Цена на зарядно (£)</label>
            <input id="charger_cost" type="number" step="1" min="0" value="700" />
          </div>
          <div>
            <label>Инсталация (£)</label>
            <input id="install_cost" type="number" step="1" min="0" value="300" />
          </div>
        </div>
      </details>

      <div id="lastBackupLine" class="small" style="margin-top:10px; display:none"></div>
    </div>

    <!-- COMPARE -->
    <div id="tab-compare" class="section">
      <details open>
        <summary>ICE vs EV</summary>
        <div class="divider"></div>
        <div class="row3">
          <div>
            <label>ICE разход (MPG UK)</label>
            <input id="ice_mpg" type="number" step="0.1" min="1" value="45" />
          </div>
          <div>
            <label>EV ефективност (miles/kWh)</label>
            <input id="ev_mpkwh" type="number" step="0.1" min="0.1" value="3" />
          </div>
          <div>
            <label>Цена гориво (£/литър)</label>
            <input id="fuel_price" type="number" step="0.01" min="0" value="1.50" />
          </div>
        </div>
      </details>

      <div class="divider"></div>

      <div class="kpi">
        <div class="box">
          <div class="t">Оценени мили (от твоите записи)</div>
          <div class="v" id="est_miles">—</div>
          <div class="small">miles</div>
        </div>
        <div class="box">
          <div class="t">ICE цена за тези мили</div>
          <div class="v" id="ice_cost">—</div>
          <div class="small">£</div>
        </div>
        <div class="box">
          <div class="t">EV цена за тези мили</div>
          <div class="v" id="ev_cost_for_miles">—</div>
          <div class="small">£ (реално платено)</div>
        </div>
        <div class="box">
          <div class="t">Разлика (ICE − EV)</div>
          <div class="v" id="ice_vs_ev_diff">—</div>
          <div class="small">£ (плюс = EV по-евтино)</div>
        </div>
      </div>

      <details style="margin-top:10px">
        <summary>Details (breakdown)</summary>
        <div class="divider"></div>
        <div class="small" id="breakdown_compare"></div>
      </details>
    </div>

  </div>
</div>

<div id="toast" aria-live="polite"></div>

<script>
  const $ = (id) => document.getElementById(id);

  // ---------- Storage ----------
  const STORAGE_KEY = "ev_log_final_v1";
  const LEGACY_KEYS = [
    "ev_log_tabs_v3_edit_filter_same",
    "ev_log_tabs_v2_savedcol",
    "ev_log_tabs_v1",
    "ev_log_v3_stacked_prices_ice",
    "ev_log_v2_payback",
    "ev_log_v1"
  ];

  // ---------- Edit drafts ----------
  let editingId = null;
  const editDrafts = new Map();

  // ---------- Filter ----------
  let currentFilter = localStorage.getItem("ev_month_filter") || "all"; // all | this | last

  // ---------- Toast ----------
  let toastTimer = null;
  function toast(text, kind=""){
    const el = $("toast");
    if (!el) return;
    el.textContent = text || "";
    el.className = "";
    if (kind) el.classList.add(kind);
    el.classList.add("show");

    if (toastTimer) clearTimeout(toastTimer);
    toastTimer = setTimeout(()=>{
      el.classList.remove("show");
      setTimeout(()=>{ el.textContent=""; el.className=""; }, 220);
    }, 1800);
  }

  // ---------- Utils ----------
  function nowISODate(){
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const day = String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${day}`;
  }
  function num(v){ const n = Number(v); return Number.isFinite(n) ? n : 0; }
  function fmtGBP(x, decimals=2){ return "£" + (Number.isFinite(x) ? x.toFixed(decimals) : "0.00"); }
  function fmt(x, decimals=1){ return (Number.isFinite(x) ? x.toFixed(decimals) : "0.0"); }
  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }
  function genId(){
    return (crypto?.randomUUID ? crypto.randomUUID() : String(Date.now()) + Math.random().toString(16).slice(2));
  }
  function typeLabel(t){
    if (t === "public") return "Публично";
    if (t === "public_exp") return "Публично скъпо";
    if (t === "home") return "Домашно";
    if (t === "home_exp") return "Домашно скъпо";
    return "Друга";
  }
  function normalizeEntryType(t){
    if (t === "home_cheap") return "home";
    if (t === "public") return "public";
    if (t === "public_exp") return "public_exp";
    if (t === "home_exp") return "home_exp";
    return t || "custom";
  }

  function monthKeyFromISO(iso){
    return (typeof iso === "string" && iso.length >= 7) ? iso.slice(0,7) : "unknown";
  }
  function thisMonthKey(){
    return nowISODate().slice(0,7);
  }
  function lastMonthKey(){
    const [y, m] = thisMonthKey().split("-").map(n => parseInt(n,10));
    const mm = m - 1;
    if (mm >= 1) return `${y}-${String(mm).padStart(2,"0")}`;
    return `${y-1}-12`;
  }

  // ---------- State schema ----------
  function defaultState(){
    return {
      schema: 1,
      prices: { public: 0.56, public_exp: 0.76, home: 0.09, home_exp: 0.30 },
      investment: { charger: 700, install: 300 },
      compare: { ice_mpg: 45, ev_mpkwh: 3, fuel_price: 1.50 },
      entries: []
    };
  }

  function sanitizeState(obj){
    const st = defaultState();
    const o = (obj && typeof obj === "object") ? obj : {};

    const p = o.prices && typeof o.prices === "object" ? o.prices : {};
    st.prices.public = num(p.public ?? p.publicPrice ?? st.prices.public);
    st.prices.public_exp = num(p.public_exp ?? p.publicExp ?? st.prices.public_exp);
    st.prices.home = num(p.home ?? p.cheap ?? p.homeCheap ?? st.prices.home);
    st.prices.home_exp = num(p.home_exp ?? p.exp ?? p.homeExpensive ?? st.prices.home_exp);

    const inv = o.investment && typeof o.investment === "object" ? o.investment : {};
    st.investment.charger = num(inv.charger ?? st.investment.charger);
    st.investment.install = num(inv.install ?? st.investment.install);

    const c = o.compare && typeof o.compare === "object" ? o.compare : {};
    st.compare.ice_mpg = num(c.ice_mpg ?? st.compare.ice_mpg) || st.compare.ice_mpg;
    st.compare.ev_mpkwh = num(c.ev_mpkwh ?? st.compare.ev_mpkwh) || st.compare.ev_mpkwh;
    st.compare.fuel_price = num(c.fuel_price ?? st.compare.fuel_price);

    const arr = Array.isArray(o.entries) ? o.entries : [];
    st.entries = arr.map(e => sanitizeEntry(e)).filter(Boolean);
    st.entries.sort(stableEntrySort);

    return st;
  }

  function sanitizeEntry(e){
    if (!e || typeof e !== "object") return null;
    const date = (typeof e.date === "string" && /^\d{4}-\d{2}-\d{2}$/.test(e.date)) ? e.date : nowISODate();
    const type = normalizeEntryType(e.type);
    const price = num(e.price);
    const kwh = num(e.kwh);
    const note = (typeof e.note === "string") ? e.note.trim() : "";
    const id = (typeof e.id === "string" && e.id.length >= 6) ? e.id : genId();
    const createdAt = (typeof e.createdAt === "string" && e.createdAt.length >= 10) ? e.createdAt : new Date().toISOString();

    if (!(kwh >= 0) || !(price >= 0)) return null;
    return { id, date, type, price, kwh, note, createdAt };
  }

  function stableEntrySort(a,b){
    if (a.date !== b.date) return a.date.localeCompare(b.date);
    const ac = a.createdAt || "";
    const bc = b.createdAt || "";
    if (ac !== bc) return ac.localeCompare(bc);
    return (a.id||"").localeCompare(b.id||"");
  }

  function loadState(){
    const raw = localStorage.getItem(STORAGE_KEY);
    if (raw){
      try{ return sanitizeState(JSON.parse(raw)); }catch(e){}
    }
    for (const key of LEGACY_KEYS){
      const legacyRaw = localStorage.getItem(key);
      if (!legacyRaw) continue;
      try{
        const legacy = JSON.parse(legacyRaw);
        const st = sanitizeState(legacy);
        localStorage.setItem(STORAGE_KEY, JSON.stringify(st));
        return st;
      }catch(e){}
    }
    return defaultState();
  }

  function saveState(state){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  }

  // ---------- Core math ----------
  function calcTotalsForEntries(state, entries){
    const basePublic = num(state.prices.public);
    let kwh = 0, cost = 0, saved = 0, publicCost = 0;

    const byType = {};
    for (const e of entries){
      const ek = num(e.kwh);
      const ep = num(e.price);
      const ec = ek * ep;

      kwh += ek;
      cost += ec;

      const t = e.type || "custom";
      if (!byType[t]) byType[t] = { kwh:0, cost:0, count:0 };
      byType[t].kwh += ek;
      byType[t].cost += ec;
      byType[t].count++;

      const isPublic = (t === "public" || t === "public_exp");
      if (isPublic) publicCost += ec;
      if (!isPublic) saved += (basePublic - ep) * ek;
    }

    return { kwh, cost, saved, publicCost, byType, basePublic };
  }

  function breakdownText(totals){
    const order = ["public","public_exp","home","home_exp","custom"];
    const parts = [];
    for (const t of order){
      if (!totals.byType[t]) continue;
      const b = totals.byType[t];
      parts.push(`${typeLabel(t)}: ${fmt(b.kwh,1)} kWh, ${fmtGBP(b.cost,2)} (${b.count})`);
    }
    return parts.length
      ? (parts.join(" • ") + ` • base public ${fmtGBP(totals.basePublic,3)}/kWh`)
      : "Няма записи.";
  }

  // ---------- Filter ----------
  function filterEntries(entries){
    if (currentFilter === "all") return entries;
    const thisKey = thisMonthKey();
    const lastKey = lastMonthKey();
    return entries.filter(e => {
      const k = monthKeyFromISO(e.date);
      return currentFilter === "this" ? k === thisKey : k === lastKey;
    });
  }

  // ---------- Edit drafts ----------
  function startEdit(entry){
    editingId = entry.id;
    editDrafts.set(entry.id, {
      type: entry.type,
      kwh: num(entry.kwh),
      price: num(entry.price),
      note: entry.note || ""
    });
  }
  function cancelEdit(){
    if (editingId) editDrafts.delete(editingId);
    editingId = null;
  }
  function saveEdit(state){
    const id = editingId;
    const d = id ? editDrafts.get(id) : null;
    if (!id || !d) return;

    const idx = state.entries.findIndex(e => e.id === id);
    if (idx >= 0){
      state.entries[idx] = { ...state.entries[idx], ...d };
      state.entries = state.entries.map(sanitizeEntry).filter(Boolean);
      state.entries.sort(stableEntrySort);
    }

    editDrafts.delete(id);
    editingId = null;

    saveState(state);
    render(state);
    toast("Saved ✅", "good");
  }

  // ---------- UI helpers ----------
  function syncInputs(state){
    $("p_public").value = state.prices.public;
    $("p_public_exp").value = state.prices.public_exp;
    $("p_home").value = state.prices.home;
    $("p_home_exp").value = state.prices.home_exp;

    $("charger_cost").value = state.investment.charger;
    $("install_cost").value = state.investment.install;

    $("ice_mpg").value = state.compare.ice_mpg;
    $("ev_mpkwh").value = state.compare.ev_mpkwh;
    $("fuel_price").value = state.compare.fuel_price;

    $("monthFilter").value = currentFilter;
  }

  function readInputsToState(state){
    state.prices.public = num($("p_public").value);
    state.prices.public_exp = num($("p_public_exp").value);
    state.prices.home = num($("p_home").value);
    state.prices.home_exp = num($("p_home_exp").value);

    state.investment.charger = num($("charger_cost").value);
    state.investment.install = num($("install_cost").value);

    state.compare.ice_mpg = Math.max(0.1, num($("ice_mpg").value) || 45);
    state.compare.ev_mpkwh = Math.max(0.1, num($("ev_mpkwh").value) || 3);
    state.compare.fuel_price = Math.max(0, num($("fuel_price").value));
  }

  function currentPriceForType(state, t){
    if (t === "public") return num(state.prices.public);
    if (t === "public_exp") return num(state.prices.public_exp);
    if (t === "home") return num(state.prices.home);
    if (t === "home_exp") return num(state.prices.home_exp);
    return 0;
  }

  function autoFillEntryPrice(state){
    const t = $("e_type").value;
    if (t === "custom") return;
    $("e_price").value = currentPriceForType(state, t).toFixed(3);
  }

  // ---------- Actions ----------
  function addEntry(state){
    cancelEdit();

    const date = $("e_date").value || nowISODate();
    const kwh = num($("e_kwh").value);
    const type = $("e_type").value;
    const price = num($("e_price").value);
    const note = ($("e_note").value || "").trim();

    if (!(kwh > 0)) { toast("Въведи kWh", "bad"); return; }
    if (!(price >= 0)) { toast("Въведи цена", "bad"); return; }

    const entry = sanitizeEntry({
      id: genId(),
      date,
      type,
      price,
      kwh,
      note,
      createdAt: new Date().toISOString()
    });

    state.entries.push(entry);
    state.entries.sort(stableEntrySort);
    saveState(state);
    render(state);

    $("e_kwh").value = "";
    $("e_note").value = "";
    $("e_date").value = date;
    if (type !== "custom") autoFillEntryPrice(state);

    $("e_kwh").focus();
    toast("Добавено ✅", "good");
  }

  function deleteEntry(state, id){
    cancelEdit();
    state.entries = state.entries.filter(e => e.id !== id);
    saveState(state);
    render(state);
    toast("Изтрито ✅", "good");
  }

  function latestEntry(entries){
    if (!entries.length) return null;
    return entries.reduce((best, e) => {
      const b = best?.createdAt ? Date.parse(best.createdAt) : Date.parse((best?.date || "1970-01-01") + "T00:00:00Z");
      const n = e?.createdAt ? Date.parse(e.createdAt) : Date.parse((e?.date || "1970-01-01") + "T00:00:00Z");
      return (n > b) ? e : best;
    }, entries[0]);
  }

  function applySameAsLast(state){
    cancelEdit();
    const last = latestEntry(state.entries);
    if (!last){
      toast("Няма предишен запис", "bad");
      return;
    }
    $("e_date").value = nowISODate();
    $("e_type").value = last.type || "custom";
    $("e_price").value = num(last.price).toFixed(3);
    $("e_kwh").value = num(last.kwh) ? String(num(last.kwh)) : "";
    $("e_note").value = last.note || "";
    $("e_kwh").focus();
    toast("Попълнено ✅", "good");
  }

  function duplicateEntry(state, entry){
    cancelEdit();
    const copy = sanitizeEntry({
      id: genId(),
      date: nowISODate(),
      type: entry.type,
      price: num(entry.price),
      kwh: num(entry.kwh),
      note: entry.note || "",
      createdAt: new Date().toISOString()
    });

    state.entries.push(copy);
    state.entries.sort(stableEntrySort);
    saveState(state);
    render(state);
    toast("Копирано ✅", "good");
  }

  // ---------- Export/Import ----------
  function downloadText(filename, text){
    const blob = new Blob([text], { type: "text/plain;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  function exportJSON(state){
    const payload = JSON.stringify(state, null, 2);
    if (navigator.clipboard?.writeText){
      navigator.clipboard.writeText(payload)
        .then(()=> toast("Export копиран ✅", "good"))
        .catch(()=> { downloadText(`ev_export_${nowISODate()}.json`, payload); toast("Clipboard fail → file ✅","good"); });
    } else {
      downloadText(`ev_export_${nowISODate()}.json`, payload);
      toast("Export file ✅", "good");
    }
  }

  function importJSONPrompt(){
    cancelEdit();
    const raw = prompt("Paste JSON (замества текущите данни):");
    if (!raw) return null;
    try{
      const parsed = JSON.parse(raw);
      const newState = sanitizeState(parsed);
      localStorage.setItem(STORAGE_KEY, JSON.stringify(newState));
      toast("Import OK ✅", "good");
      return newState;
    }catch(e){
      toast("Грешен JSON ❌", "bad");
      return null;
    }
  }

  function csvEscape(v){
    const s = String(v ?? "");
    if (/[",\n]/.test(s)) return `"${s.replaceAll('"', '""')}"`;
    return s;
  }

  function exportCSV(state){
    cancelEdit();
    const basePublic = num(state.prices.public);
    const header = ["Date","Type","kWh","Price_per_kWh","Cost_GBP","Saved_vs_BasePublic_GBP","Note"];
    const rows = state.entries.map(e => {
      const k = num(e.kwh);
      const p = num(e.price);
      const cost = k * p;
      const isPublic = (e.type === "public" || e.type === "public_exp");
      const saved = !isPublic ? (basePublic - p) * k : 0;
      return [
        e.date,
        e.type,
        k.toFixed(1),
        p.toFixed(3),
        cost.toFixed(2),
        saved.toFixed(2),
        e.note || ""
      ];
    });

    const csv = [header, ...rows]
      .map(r => r.map(csvEscape).join(","))
      .join("\n");

    downloadText(`ev_log_${nowISODate()}.csv`, csv);
    toast("CSV изтеглен ✅", "good");
  }

  function downloadJSONFile(state){
    cancelEdit();
    const filename = `ev_backup_${nowISODate()}.json`;
    const text = JSON.stringify(state, null, 2);
    downloadText(filename, text);

    localStorage.setItem("ev_last_backup", new Date().toISOString());
    render(state);

    toast("Backup файл ✅", "good");
  }

  function restoreFromJSONText(text){
    cancelEdit();
    const parsed = JSON.parse(text);
    const newState = sanitizeState(parsed);
    localStorage.setItem(STORAGE_KEY, JSON.stringify(newState));
    localStorage.setItem("ev_last_backup", new Date().toISOString());
    toast("Restore OK ✅", "good");
    return newState;
  }

  function restoreJSONFile(stateSetter){
    const input = $("restoreFileInput");
    input.value = "";
    input.click();

    input.onchange = async () => {
      const file = input.files?.[0];
      if (!file) return;

      try{
        const text = await file.text();
        const newState = restoreFromJSONText(text);
        stateSetter(newState);
      }catch(e){
        toast("Restore failed ❌", "bad");
      }
    };
  }

  // ---------- Compare ----------
  function compareTotals(state, totalsAll){
    const iceMPG = Math.max(0.1, num(state.compare.ice_mpg));
    const evMPKWh = Math.max(0.1, num(state.compare.ev_mpkwh));
    const fuelPrice = Math.max(0, num(state.compare.fuel_price));

    const estMiles = totalsAll.kwh * evMPKWh;
    const ukGallons = estMiles / iceMPG;
    const liters = ukGallons * 4.54609;
    const iceCost = liters * fuelPrice;
    const diff = iceCost - totalsAll.cost;

    return { estMiles, iceCost, diff };
  }

  // ---------- Render ----------
  function render(state){
    const totalsAll = calcTotalsForEntries(state, state.entries);

    $("tot_kwh").textContent = fmt(totalsAll.kwh, 1);
    $("tot_cost").textContent = fmtGBP(totalsAll.cost, 2);
    $("public_cost").textContent = fmtGBP(totalsAll.publicCost, 2);
    $("saved_vs_public").textContent = fmtGBP(totalsAll.saved, 2);

    const investment = num(state.investment.charger) + num(state.investment.install);
    $("inv_total").textContent = fmtGBP(investment, 0);

    const remain = investment + totalsAll.publicCost - totalsAll.saved;
    const remainEl = $("remain_payback");
    remainEl.textContent = fmtGBP(remain, 2);
    if (remain <= 0){
      remainEl.className = "v good";
      $("remain_note").textContent = "✅ Изплатено/надминато";
    } else {
      remainEl.className = "v";
      $("remain_note").textContent = "Инвестиция + публични − спестено";
    }

    const cmp = compareTotals(state, totalsAll);
    $("est_miles").textContent = cmp.estMiles.toFixed(0);
    $("ice_cost").textContent = fmtGBP(cmp.iceCost, 2);
    $("ev_cost_for_miles").textContent = fmtGBP(totalsAll.cost, 2);
    const diffEl = $("ice_vs_ev_diff");
    diffEl.textContent = fmtGBP(cmp.diff, 2);
    diffEl.className = "v " + (cmp.diff >= 0 ? "good" : "bad");

    const bAll = breakdownText(totalsAll);
    $("breakdown_log").textContent = bAll;
    $("breakdown_summary").textContent = bAll;
    $("breakdown_compare").textContent = bAll;

    const thisKey = thisMonthKey();
    const lastKey = lastMonthKey();

    const thisEntries = state.entries.filter(e => monthKeyFromISO(e.date) === thisKey);
    const lastEntries = state.entries.filter(e => monthKeyFromISO(e.date) === lastKey);

    const thisTotals = calcTotalsForEntries(state, thisEntries);
    const lastTotals = calcTotalsForEntries(state, lastEntries);

    const monthLineEl = $("monthLine");
    if (thisTotals.kwh > 0 || thisTotals.cost > 0 || thisTotals.saved !== 0){
      monthLineEl.textContent = `This month: ${fmt(thisTotals.kwh,1)} kWh · ${fmtGBP(thisTotals.cost,2)} · Saved ${fmtGBP(thisTotals.saved,2)}`;
      monthLineEl.style.display = "block";
    } else {
      monthLineEl.textContent = "";
      monthLineEl.style.display = "none";
    }

    const lastMonthLineEl = $("lastMonthLine");
    if (lastTotals.kwh > 0 || lastTotals.cost > 0 || lastTotals.saved !== 0){
      lastMonthLineEl.textContent = `Last month: ${fmt(lastTotals.kwh,1)} kWh · ${fmtGBP(lastTotals.cost,2)} · Saved ${fmtGBP(lastTotals.saved,2)}`;
      lastMonthLineEl.style.display = "block";
    } else {
      lastMonthLineEl.textContent = "";
      lastMonthLineEl.style.display = "none";
    }

    const lb = localStorage.getItem("ev_last_backup");
    const lbEl = $("lastBackupLine");
    if (lbEl){
      if (lb){
        const d = new Date(lb);
        lbEl.textContent = `Last backup: ${d.toLocaleString()}`;
        lbEl.style.display = "block";
      } else {
        lbEl.textContent = "";
        lbEl.style.display = "none";
      }
    }

    const visibleEntries = filterEntries(state.entries);
    const totalsVisible = calcTotalsForEntries(state, visibleEntries);

    const tbody = $("tbody");
    tbody.innerHTML = "";

    const basePublic = totalsAll.basePublic;

    for (const e of visibleEntries){
      const isEditing = (editingId === e.id);
      const d = isEditing ? editDrafts.get(e.id) : null;

      const viewType = isEditing ? d.type : e.type;
      const viewKwh  = isEditing ? d.kwh  : num(e.kwh);
      const viewPrice= isEditing ? d.price: num(e.price);
      const viewNote = isEditing ? d.note : (e.note || "");

      const cost = viewKwh * viewPrice;
      const isPublic = (viewType === "public" || viewType === "public_exp");
      const saved = !isPublic ? (basePublic - viewPrice) * viewKwh : 0;

      const tr = document.createElement("tr");

      const tdDate = document.createElement("td");
      tdDate.textContent = e.date;

      const tdType = document.createElement("td");
      if (isEditing){
        const sel = document.createElement("select");
        ["public","public_exp","home","home_exp","custom"].forEach(t=>{
          const o = document.createElement("option");
          o.value = t;
          o.textContent = typeLabel(t);
          if (t === viewType) o.selected = true;
          sel.appendChild(o);
        });
        sel.onchange = () => { d.type = sel.value; render(state); };
        tdType.appendChild(sel);

        const noteInp = document.createElement("input");
        noteInp.type = "text";
        noteInp.value = viewNote;
        noteInp.oninput = () => { d.note = noteInp.value; };
        noteInp.style.marginTop = "6px";
        tdType.appendChild(noteInp);
      } else {
        tdType.innerHTML =
          `<span class="tag">${typeLabel(viewType)}</span>` +
          (viewNote ? `<span class="note">${escapeHtml(viewNote)}</span>` : "");
      }

      const tdKwh = document.createElement("td");
      if (isEditing){
        const inp = document.createElement("input");
        inp.type = "number";
        inp.step = "0.1";
        inp.value = viewKwh;
        inp.oninput = () => { d.kwh = num(inp.value); };
        tdKwh.appendChild(inp);
      } else {
        tdKwh.textContent = fmt(viewKwh, 1);
      }

      const tdPrice = document.createElement("td");
      if (isEditing){
        const inp = document.createElement("input");
        inp.type = "number";
        inp.step = "0.001";
        inp.value = viewPrice;
        inp.oninput = () => { d.price = num(inp.value); };
        tdPrice.appendChild(inp);
      } else {
        tdPrice.textContent = viewPrice.toFixed(3);
      }

      const tdCost = document.createElement("td");
      tdCost.textContent = fmtGBP(cost, 2);

      const tdSaved = document.createElement("td");
      tdSaved.textContent = fmtGBP(saved, 2);
      if (saved > 0) tdSaved.className = "good";
      if (saved < 0) tdSaved.className = "bad";

      const tdCopy = document.createElement("td");
      const copyBtn = document.createElement("button");
      copyBtn.className = "mini";
      copyBtn.textContent = "Copy";
      copyBtn.onclick = () => duplicateEntry(state, e);
      tdCopy.appendChild(copyBtn);

      const tdEdit = document.createElement("td");
      const editBtn = document.createElement("button");
      editBtn.className = "mini";
      editBtn.textContent = isEditing ? "Save" : "Edit";
      editBtn.onclick = () => {
        if (isEditing){
          saveEdit(state);
        } else {
          cancelEdit();
          startEdit(e);
          render(state);
        }
      };
      tdEdit.appendChild(editBtn);

      const tdDel = document.createElement("td");
      tdDel.className = "right";
      const delBtn = document.createElement("button");
      delBtn.className = "mini";
      delBtn.textContent = isEditing ? "Cancel" : "Del";
      delBtn.onclick = () => {
        if (isEditing){
          cancelEdit();
          render(state);
        } else {
          deleteEntry(state, e.id);
        }
      };
      tdDel.appendChild(delBtn);

      tr.appendChild(tdDate);
      tr.appendChild(tdType);
      tr.appendChild(tdKwh);
      tr.appendChild(tdPrice);
      tr.appendChild(tdCost);
      tr.appendChild(tdSaved);
      tr.appendChild(tdCopy);
      tr.appendChild(tdEdit);
      tr.appendChild(tdDel);

      tbody.appendChild(tr);
    }

    const tfoot = $("tfoot");
    tfoot.innerHTML = "";
    const label = (currentFilter === "all" ? "All" : (currentFilter === "this" ? "This month" : "Last month"));
    const trf = document.createElement("tr");
    trf.innerHTML = `
      <th colspan="2">TOTAL (${label})</th>
      <th>${fmt(totalsVisible.kwh,1)}</th>
      <th></th>
      <th>${fmtGBP(totalsVisible.cost,2)}</th>
      <th>${fmtGBP(totalsVisible.saved,2)}</th>
      <th colspan="3"></th>
    `;
    tfoot.appendChild(trf);

    syncInputs(state);
  }

  // ---------- Tabs ----------
  function wireTabs(){
    const buttons = Array.from(document.querySelectorAll(".tabbtn"));
    function activate(tabName){
      buttons.forEach(b => b.classList.toggle("active", b.dataset.tab === tabName));
      document.querySelectorAll(".section").forEach(sec => sec.classList.remove("active"));
      const target = document.getElementById("tab-" + tabName);
      if (target) target.classList.add("active");
      localStorage.setItem("ev_last_tab", tabName);
    }
    buttons.forEach(btn => btn.addEventListener("click", ()=> activate(btn.dataset.tab)));
    const last = localStorage.getItem("ev_last_tab");
    if (last) activate(last);
  }

  // ---------- Wire ----------
  function wire(){
    let state = loadState();

    $("e_date").value = nowISODate();
    syncInputs(state);
    autoFillEntryPrice(state);
    render(state);

    [
      "p_public","p_public_exp","p_home","p_home_exp",
      "charger_cost","install_cost",
      "ice_mpg","ev_mpkwh","fuel_price"
    ].forEach(id=>{
      $(id).addEventListener("input", ()=>{
        cancelEdit();
        readInputsToState(state);
        saveState(state);
        autoFillEntryPrice(state);
        render(state);
      });
    });

    $("e_type").addEventListener("change", ()=> autoFillEntryPrice(state));

    $("addBtn").addEventListener("click", ()=> addEntry(state));
    $("sameBtn").addEventListener("click", ()=> applySameAsLast(state));

    $("exportBtn").addEventListener("click", ()=> exportJSON(state));
    $("csvBtn").addEventListener("click", ()=> exportCSV(state));
    $("backupFileBtn").addEventListener("click", ()=> downloadJSONFile(state));
    $("restoreFileBtn").addEventListener("click", ()=>{
      restoreJSONFile((newState)=>{
        state = newState;
        cancelEdit();
        render(state);
        autoFillEntryPrice(state);
        syncInputs(state);
      });
    });

    $("importBtn").addEventListener("click", ()=>{
      const newState = importJSONPrompt();
      if (newState){
        state = newState;
        cancelEdit();
        render(state);
        autoFillEntryPrice(state);
        syncInputs(state);
      }
    });

    $("clearBtn").addEventListener("click", ()=>{
      if (!confirm("Да изтрия всичко?")) return;
      cancelEdit();
      state.entries = [];
      saveState(state);
      render(state);
      toast("Изчистено ✅", "good");
    });

    $("monthFilter").addEventListener("change", (e)=>{
      currentFilter = e.target.value;
      localStorage.setItem("ev_month_filter", currentFilter);
      cancelEdit();
      render(state);
    });

    // Fast keyboard flow (Enter)
    $("e_date").addEventListener("keydown", (ev)=>{
      if (ev.key !== "Enter") return;
      ev.preventDefault();
      $("e_kwh").focus();
    });
    $("e_kwh").addEventListener("keydown", (ev)=>{
      if (ev.key !== "Enter") return;
      ev.preventDefault();
      $("e_price").focus();
    });
    $("e_price").addEventListener("keydown", (ev)=>{
      if (ev.key !== "Enter") return;
      ev.preventDefault();
      $("e_note").focus();
    });
    $("e_note").addEventListener("keydown", (ev)=>{
      if (ev.key !== "Enter") return;
      ev.preventDefault();
      addEntry(state);
    });

    wireTabs();
  }

  wire();
</script>

<!-- Service Worker registration -->
<script>
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", async () => {
      try {
        await navigator.serviceWorker.register("./sw.js", { scope: "./" });
      } catch (e) {}
    });
  }
</script>

</body>
</html>
